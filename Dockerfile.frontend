# syntax=docker/dockerfile:1

FROM node:23-slim AS build

WORKDIR /app

RUN npm install -g pnpm

COPY package*.json pnpm-lock.yaml ./

RUN --mount=type=cache,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile

COPY . .

ARG VITE_API_URL
ARG VITE_GOOGLE_MAPS_API_KEY
ARG VITE_MAPBOX_PUBLIC_TOKEN
ARG VITE_BUNNYCDN_BASE_URL

ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_GOOGLE_MAPS_API_KEY=${VITE_GOOGLE_MAPS_API_KEY}
ENV VITE_MAPBOX_PUBLIC_TOKEN=${VITE_MAPBOX_PUBLIC_TOKEN}
ENV VITE_BUNNYCDN_BASE_URL=${VITE_BUNNYCDN_BASE_URL}

RUN pnpm run frontend:build

FROM nginx:1.28-alpine

RUN rm -rf /usr/share/nginx/html/*

COPY --from=build /app/build /usr/share/nginx/html

# Copy custom nginx main config
COPY nginx/nginx.conf /etc/nginx/nginx.conf

# Copy site config (default.conf)
COPY nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
